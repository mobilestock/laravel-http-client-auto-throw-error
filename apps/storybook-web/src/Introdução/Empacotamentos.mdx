import { Meta } from '@storybook/blocks'

<Meta title="Introdução/Empacotamentos" />

# Como criar pacotes de componentes para o npm

## Boas práticas

- Sempre que criar um novo componente, verifique se ele pode ser reutilizado em outros projetos.
- Lembre-se sempre de verificar as dependências do componente e se elas são necessárias para o funcionamento do mesmo.
- Revise rigorosamente o arquivo `package.json` do componente, verificando se todas as dependências estão corretas e se não há dependências desnecessárias ou faltantes.
- Verifique se os testes unitários estão passando e se o componente está funcionando corretamente.

### Recomendações:

1. **Ambiente de Construção**:

- Ao empacotar os componentes, assegure-se de que todos os caminhos sejam resolvidos corretamente e que não exista dependência de alias de configuração externa ao pacote.

2. **Testar o Pacote de Forma Independente**:

- Para testar o pacote localmente (`npm pack --dry-run` na pasta `packages/<Seu Componente>`, com o [Verdaccio](https://verdaccio.org/) instalado e configurado, faça um `npm publish` e depois `yarn add @<escopo desejado>/<nome do pacote desejado>` no projeto onde deseja testar) para garantir que todas as dependências foram resolvidas corretamente e que não há problemas internos na lib empacotada.

## Diretórios

Ao criar novos componentes nas aplicações, adotamos a estrategia de colocar os arquivos `index.tsx`, `index.stories.tsx`, `SeuComponente.test.tsx` e `SeuComponente.mdx` na mesma pasta do componente.

### Estrutura de diretórios

```
packages/
└── SeuComponente/
    ├── index.tsx
    ├── index.stories.tsx
    ├── SeuComponente.mdx
    └── SeuComponente.test.tsx
```

Caso ele possua sub-componentes, você pode criar uma pasta para ele e seguir a mesma estrutura:

```
packages/
└── SeuComponente/
    ├── index.tsx
    ├── index.stories.tsx
    ├── SeuComponente.mdx
    ├── SeuComponente.test.tsx
    └── SubComponente/
        ├── index.tsx
        ├── index.stories.tsx
        ├── SubComponente.mdx
        └── SubComponente.test.tsx
```

## Verdaccio
### Configurando o Verdaccio

- Para testar pacotes localmente, você pode utilizar o Verdaccio, um servidor de pacotes npm privado. Para configurá-lo, siga os passos abaixo:

```bash
docker run -d --name verdaccio -p 4873:4873 verdaccio/verdaccio
```

- Adicione o Verdaccio como um registry local na sua máquina:

```bash
npm set registry http://localhost:4873/
```

- Após a execução do comando, acesse o Verdaccio em `http://localhost:4873/` e siga as instruções para criar um usuário e senha genêricos apenas para fins de teste.

```bash
npm adduser --registry http://localhost:4873
```

- Para publicar um pacote localmente, acesse a pasta do pacote que deseja publicar e execute o comando:

```bash
npm pack --dry-run # Para ver o que será empacotado
npm publish # Para publicar no Verdaccio localmente
```

- Caso você esteja no diretório raiz e deseje publicar os pacotes, já existem os scripts:
  > Cuidado com esses comandos, pois eles atualizam a versão do pacote automaticamente e já fazem um commit na sua branch.

```bash
npm run publicar:web # Para publicar o pacote @mobilestock/web e atualizar a versão automaticamente.
npm run publicar:native # Para publicar o pacote @mobilestock/native e atualizar a versão automaticamente.
```

- É sempre bom remover a imagem do Verdaccio após o uso, e reverter o registry para o npm oficial:

```bash
docker rm -f verdaccio
npm config set registry https://registry.npmjs.org/
```


## Publicações
### Publicando um pacote

- Primeiramente, você precisa ser um membro das organizações de escopo da empresa no npm.
- Depois basta fazer um `npm adduser` e logar na sua conta do npm.
- Para fazer a publicaçaõ automatica de todos os pacotes, siga os seguintes passos:
  - Descomentar a linha 3 do arquivo `.npmrc` na raiz do projeto.
  - Executar os seguintes comandos docker:
    ```bash
    docker build -t autopublish-image -f Dockerfile .
    ```
    ```bash
    docker run --rm \
      -e NPM_TOKEN="<TOKEN_AQUI>" \
      -v $(pwd)/.npmrc:/root/.npmrc \
      -v $(pwd)/scripts/autoPublish:/root/scripts/autoPublish \
      -v $(pwd)/apps/storybook-native/src/packages:/root/apps/storybook-native/src/packages \
      -v $(pwd)/apps/storybook-web/src/packages:/root/apps/storybook-web/src/packages \
      autopublish-image
    ```

### Algo foi publicado errado?

- Se o pacote foi publicado há mais de 72 horas, o npm não permite despublicar o pacote.
- Para despublicar dentro desse período, execute o seguinte comando:

```bash
npm unpublish @seu-escopo/nome-do-pacote --force
```

- **CUIDADO** com esse comando, pois ele remove a versão do pacote do npm e pode quebrar dependências de outros pacotes.
- Caso você tenha publicado algo errado, a melhor prática é publicar uma nova versão corrigida e informar a equipe sobre o erro.
- Uma vez publicado, o pacote não pode ser removido, apenas despublicado.
- A versão despublicada não pode ser publicada novamente, logo se a versão 1.0.0 foi despublicada, nunca mais será possivel publicar a versão 1.0.0, e caso tenha de republicar vai precisar usar uma versão diferente que nunca foi usada antes, como no exemplo citado neste trecho, sua proxima publicação deverá ser no minimo na versão 1.0.1.
